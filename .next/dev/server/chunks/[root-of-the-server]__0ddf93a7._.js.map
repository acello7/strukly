{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/kimoc/OneDrive/Desktop/KolosalAProject/strukly/app/api/chat/ocr/route.ts"],"sourcesContent":["// app/api/chat/ocr/route.ts\nimport { NextResponse } from \"next/server\";\n\nconst API_KEY = process.env.GEMINI_API_KEY; // Atau KOLOSAL_API_KEY\nconst MODEL_NAME = \"gemini-2.0-flash\"; \nconst MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    const { image } = body;\n\n    if (!image) return NextResponse.json({ error: \"Image missing\" }, { status: 400 });\n\n    const base64Data = image.replace(/^data:image\\/\\w+;base64,/, \"\");\n\n    // PERUBAHAN PROMPT: Tambahkan field \"total_amount\"\n    const prompt = `\n      Extract receipt data into strict JSON.\n      JSON Structure:\n      {\n        \"merchant\": \"Store Name\",\n        \"total_amount\": 0,  // <-- Cari angka Total Akhir (Grand Total) di struk\n        \"items\": [\n          {\n            \"name\": \"Item Name\",\n            \"quantity\": 1, \n            \"price\": 10000 // Harga SATUAN (Unit Price). Jika struk hanya menampilkan total per baris, bagi dengan quantity.\n          }\n        ]\n      }\n      Rules:\n      - \"total_amount\" harus angka final (termasuk pajak/diskon).\n      - Return ONLY raw JSON.\n    `;\n\n    const payload = {\n      contents: [{\n        parts: [\n          { text: prompt },\n          { inline_data: { mime_type: \"image/jpeg\", data: base64Data } }\n        ]\n      }]\n    };\n\n    const res = await fetch(`${MODEL_URL}?key=${API_KEY}`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(payload)\n    });\n\n    // ... (Sisa kode sama: error handling & parsing JSON) ...\n    \n    const data = await res.json();\n    let text = data.candidates?.[0]?.content?.parts?.[0]?.text;\n    text = text.replace(/```json/g, \"\").replace(/```/g, \"\").trim();\n    \n    const firstBrace = text.indexOf(\"{\");\n    const lastBrace = text.lastIndexOf(\"}\");\n    if (firstBrace !== -1 && lastBrace !== -1) {\n       text = text.substring(firstBrace, lastBrace + 1);\n    }\n\n    return NextResponse.json(JSON.parse(text));\n\n  } catch (err: any) {\n    return NextResponse.json({ error: \"Server Error\", details: err.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"AAAA,4BAA4B;;;;;AAC5B;;AAEA,MAAM,UAAU,QAAQ,GAAG,CAAC,cAAc,EAAE,uBAAuB;AACnE,MAAM,aAAa;AACnB,MAAM,YAAY,CAAC,wDAAwD,EAAE,WAAW,gBAAgB,CAAC;AAElG,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,GAAG;QAElB,IAAI,CAAC,OAAO,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAgB,GAAG;YAAE,QAAQ;QAAI;QAE/E,MAAM,aAAa,MAAM,OAAO,CAAC,4BAA4B;QAE7D,mDAAmD;QACnD,MAAM,SAAS,CAAC;;;;;;;;;;;;;;;;;IAiBhB,CAAC;QAED,MAAM,UAAU;YACd,UAAU;gBAAC;oBACT,OAAO;wBACL;4BAAE,MAAM;wBAAO;wBACf;4BAAE,aAAa;gCAAE,WAAW;gCAAc,MAAM;4BAAW;wBAAE;qBAC9D;gBACH;aAAE;QACJ;QAEA,MAAM,MAAM,MAAM,MAAM,GAAG,UAAU,KAAK,EAAE,SAAS,EAAE;YACrD,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,KAAK,SAAS,CAAC;QACvB;QAEA,0DAA0D;QAE1D,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,IAAI,OAAO,KAAK,UAAU,EAAE,CAAC,EAAE,EAAE,SAAS,OAAO,CAAC,EAAE,EAAE;QACtD,OAAO,KAAK,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,QAAQ,IAAI,IAAI;QAE5D,MAAM,aAAa,KAAK,OAAO,CAAC;QAChC,MAAM,YAAY,KAAK,WAAW,CAAC;QACnC,IAAI,eAAe,CAAC,KAAK,cAAc,CAAC,GAAG;YACxC,OAAO,KAAK,SAAS,CAAC,YAAY,YAAY;QACjD;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC,KAAK,KAAK,CAAC;IAEtC,EAAE,OAAO,KAAU;QACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;YAAgB,SAAS,IAAI,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IAC1F;AACF"}}]
}